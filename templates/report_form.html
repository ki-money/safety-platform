<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Submit Incident Report</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px 0; }
        .report-card { background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); margin: 20px 0 30px; }
        .success-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; align-items: center; justify-content: center; }
        .success-modal.active { display: flex; }
        .success-content { background: white; padding: 40px; border-radius: 15px; max-width: 500px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
        .success-icon { font-size: 64px; color: #28a745; margin-bottom: 20px; }
        .report-id-display { background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0; border: 2px dashed #667eea; }
        .report-id-number { font-size: 32px; font-weight: bold; color: #667eea; font-family: 'Courier New', monospace; letter-spacing: 2px; }
        .btn-group-modal { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        .btn-group-modal .btn { min-width: 150px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="text-center text-white mb-4">
            <a href="/" class="btn btn-light mb-3">← Back to Home</a>
            <h1 class="display-5 fw-bold">Submit Incident Report</h1>
            <p class="lead">Report safely and anonymously to Police</p>
        </div>

        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="report-card p-5">
                    <div class="text-center mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#667eea" stroke-width="2">
                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                        </svg>
                        <h3 class="mt-3">Your Report is Anonymous</h3>
                        <p class="text-muted">No personal information is collected. Your safety is our priority.</p>
                    </div>

                    <form method="POST" action="/report" enctype="multipart/form-data" id="incidentForm">
                        <div class="mb-4">
                            <label for="category" class="form-label fw-bold">Incident Category *</label>
                            <input type="text" class="form-control form-control-lg" id="category" name="category" required
                                   placeholder="e.g., Theft, Assault, Road Accident">
                            <small class="text-muted">Briefly describe the type of incident</small>
                        </div>

                        <div class="mb-4">
                            <label for="description" class="form-label fw-bold">Detailed Description *</label>
                            <textarea class="form-control form-control-lg" id="description" name="description" rows="5" required
                                      placeholder="What happened? When? Who was involved? Any witnesses?"></textarea>
                            <small class="text-muted">The more details you provide, the better we can respond</small>
                        </div>

                        <div class="mb-4">
                            <label for="manual_location" class="form-label fw-bold">Location/Address *</label>
                            <input type="text" class="form-control form-control-lg" id="manual_location" name="manual_location" required
                                   placeholder="e.g., Near Rongai Market, Kenyatta Avenue">
                            <small class="text-muted">Be as specific as possible</small>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <label for="constituency" class="form-label fw-bold">Constituency *</label>
                                <select class="form-select form-select-lg" id="constituency" name="constituency" required>
                                    <option value="">Select constituency...</option>
                                    {% for const in constituencies %}
                                    <option value="{{ const[0] }}">{{ const[0] }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="col-md-6 mb-4">
                                <label for="language" class="form-label fw-bold">Preferred Language</label>
                                <select class="form-select form-select-lg" id="language" name="language">
                                    {% for lang in settings.languages %}
                                    <option value="{{ lang }}">{{ lang }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="media" class="form-label fw-bold">Attach Photo/Video (Optional)</label>
                            <input type="file" class="form-control form-control-lg" id="media" name="media"
                                   accept="image/*,video/*" onchange="validateFileSize(this)">
                            <small class="text-muted">JPG, PNG, MP4 | Max 10MB</small>
                        </div>

                        <input type="hidden" id="lat" name="lat">
                        <input type="hidden" id="lon" name="lon">

                        <div class="mb-4">
                            <button type="button" class="btn btn-outline-primary btn-lg w-100" onclick="getLocation()">
                                 Capture GPS Location (Optional)
                            </button>
                            <div id="locationStatus" class="mt-2 text-center"></div>
                        </div>

                        <hr class="my-4">

                        <div class="alert alert-info">
                            <strong>Privacy Notice:</strong> This report is completely anonymous. We do not collect or store any personal information.
                        </div>

                        <button type="submit" class="btn btn-primary btn-lg w-100 py-3" id="submitBtn">
                            Submit Anonymous Report
                        </button>
                    </form>
                </div>

                <div class="text-center text-white mt-4">
                    <p>Need immediate help? Call emergency: <strong>0725646760</strong></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="success-modal" id="successModal">
        <div class="success-content">
            <div class="success-icon">✓</div>
            <h2 class="text-success mb-3">Report Submitted Successfully!</h2>
            <p class="lead">Your report has been received and forwarded to the local police station.</p>

            <div class="report-id-display">
                <p class="mb-2"><strong>Your Report ID:</strong></p>
                <div class="report-id-number" id="displayReportId"></div>
                <small class="text-muted d-block mt-2">Save this ID to track your report</small>
            </div>

            <div class="alert alert-warning">
                <small><strong>Important:</strong> Please save this Report ID. You can use it to check the status of your report.</small>
            </div>

            <div class="btn-group-modal mt-3">
                <button type="button" class="btn btn-success btn-lg" onclick="downloadReportId()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 5px;">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    Download Report ID
                </button>
                <button type="button" class="btn btn-primary btn-lg" onclick="closeSuccessModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 5px;">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                    Close
                </button>
            </div>

            <a href="/" class="btn btn-outline-primary btn-lg mt-3 w-100">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 5px;">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
                Return Home
            </a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentReportId = '';

        function validateFileSize(input) {
            const maxSize = 10 * 1024 * 1024;
            if (input.files[0] && input.files[0].size > maxSize) {
                alert('File exceeds 10MB. Please choose a smaller file.');
                input.value = '';
            }
        }

        function getLocation() {
            if (navigator.geolocation) {
                document.getElementById('locationStatus').innerHTML = '<span class="text-info">Getting location...</span>';
                navigator.geolocation.getCurrentPosition(
                    position => {
                        document.getElementById('lat').value = position.coords.latitude;
                        document.getElementById('lon').value = position.coords.longitude;
                        document.getElementById('locationStatus').innerHTML = '<span class="text-success">✓ Location captured successfully</span>';
                    },
                    error => {
                        document.getElementById('locationStatus').innerHTML = '<span class="text-danger">✗ Failed to capture location</span>';
                    }
                );
            } else {
                document.getElementById('locationStatus').innerHTML = '<span class="text-danger">Geolocation not supported by your browser</span>';
            }
        }

        window.onload = () => {
            if (!document.getElementById('lat').value) {
                document.getElementById('lat').value = -0.3031;
                document.getElementById('lon').value = 36.0800;
            }
        };

        // Handle form submission
        document.getElementById('incidentForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Submitting...';

            const formData = new FormData(this);

            fetch('/report', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Store report ID and show success modal
                    currentReportId = data.report_id;
                    document.getElementById('displayReportId').textContent = data.report_id;
                    document.getElementById('successModal').classList.add('active');

                    // Reset form
                    document.getElementById('incidentForm').reset();
                    document.getElementById('lat').value = -0.3031;
                    document.getElementById('lon').value = 36.0800;
                    document.getElementById('locationStatus').innerHTML = '';
                } else {
                    alert('Error: ' + (data.error || 'Failed to submit report'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while submitting your report. Please try again.');
            })
            .finally(() => {
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Submit Anonymous Report';
            });
        });

        function downloadReportId() {
            if (!currentReportId) {
                alert('No report ID available');
                return;
            }

            // Create text content with report details
            const reportContent = `
NAKURU CITIZEN SAFETY REPORTING PLATFORM
=========================================

REPORT CONFIRMATION
-------------------

Report ID: ${currentReportId}

Date: ${new Date().toLocaleString()}

IMPORTANT INFORMATION:
- Keep this Report ID safe
- Use this ID to track your report status
- Visit the platform and use "Track Report" feature
- Contact: 0725646760 for emergencies

Thank you for helping keep Nakuru safe!

=========================================
© 2025 Citizen Safety Reporting Platform
            `.trim();

            // Create a blob and download
            const blob = new Blob([reportContent], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Report_ID_${currentReportId}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            // Show confirmation
            alert('Report ID downloaded successfully! Please keep this file safe.');
        }

        function closeSuccessModal() {
            document.getElementById('successModal').classList.remove('active');
            currentReportId = '';
        }

        // Close modal when clicking outside
        document.getElementById('successModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeSuccessModal();
            }
        });
    </script>
</body>
</html>