<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crime Hotspots Map - {{ station }}</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
        #map { height: 100vh; width: 100%; }
        .info-panel { position: absolute; top: 10px; right: 10px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 1000; max-width: 300px; }
        .info-panel h3 { margin: 0 0 10px 0; font-size: 18px; }
        .legend { background: white; padding: 10px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .legend-item { display: flex; align-items: center; margin-bottom: 5px; }
        .legend-color { width: 20px; height: 20px; border-radius: 50%; margin-right: 10px; }
    </style>
</head>
<body>
    <div class="info-panel">
        <h3>{{ station }} Hotspots</h3>
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background: #d32f2f;"></div>
                <span>High Risk (10+ incidents)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #f57c00;"></div>
                <span>Medium Risk (5-9 incidents)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #1976d2;"></div>
                <span>Low Risk (1-4 incidents)</span>
            </div>
        </div>
        <div class="mt-3">
            <strong>Total Hotspots:</strong> {{ hotspots|length }}
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const map = L.map('map').setView([{{ center_lat }}, {{ center_lon }}], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        }).addTo(map);

        const hotspots = {{ hotspots_json|safe }};

        hotspots.forEach(hotspot => {
            const lat = hotspot.lat;
            const lon = hotspot.lon;
            const count = hotspot.incident_count;

            let color, radius;
            if (count >= 10) {
                color = '#d32f2f';
                radius = 15;
            } else if (count >= 5) {
                color = '#f57c00';
                radius = 12;
            } else {
                color = '#1976d2';
                radius = 8;
            }

            const circle = L.circleMarker([lat, lon], {
                radius: radius,
                fillColor: color,
                color: '#fff',
                weight: 2,
                opacity: 1,
                fillOpacity: 0.7
            }).addTo(map);

            circle.bindPopup(`
                <strong>${hotspot.location}</strong><br>
                Incidents: ${count}<br>
                Last incident: ${hotspot.last_incident || 'N/A'}
            `);
        });
    </script>
</body>
</html>